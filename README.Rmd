---
title: "DenVar"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#",
  out.width = "100%",
  messages = FALSE,
  warnings = FALSE
)
```

This is a R package for visualization and supervised cell annotation of Vectra Polaris and MIBI data. The package provides basic marker visualization tools like: heat-map and ridge plot. Given a set of annotated training images, it can also perform a random forest based cell phenotyping for non-annotated images. 

## Loading required packages

First, we load our package: DenVar and a few other required packages. One can install the developmental version of VectraMIBI by running the command: **devtools::install_github('sealx017/DenVar')**. 


```{r loading packages, message=FALSE}

require(DenVar)
require(LaplacesDemon)
require(pheatmap)
require(ggplot2)
require(survminer)
require(coxme)

```

## Loading the dataset 

Next, we import the training dataset named as "train_data", which has marker data (34 many) for different cells from two different images. The first two columns: "SampleID" and "cellLabelInImage" of the training dataset respectively correspond to the image number and the cell label inside that image. The third column ("Group") corresponds to the annotated cell type. 

```{r loading the marker expression and the clinical data}
PD1_data = read.csv("Data/PD1_TNBC_MIBI.csv")[,-1]
clinical_data = read.csv("Data/Survival_TNBC_MIBI.csv")[,-1]
```


## Computing the KDEs and the JSD matrix

Next, we import the training dataset named as "train_data", which has marker data (34 many) for different cells from two different images. The first two columns: "SampleID" and "cellLabelInImage" of the training dataset respectively correspond to the image number and the cell label inside that image. The third column ("Group") corresponds to the annotated cell type. 

```{r Computing the KDEs and the JSD matrix}

KDE_of_all = Array_KDE(Data = PD1_data, ngrids = 1024)
JSD_matrix_between_all = JSD_matrix(KDE_of_all)

```


## Hierarchical clustering based on the JSD matrix

Next, we import the training dataset named as "train_data", which has marker data (34 many) for different cells from two different images. The first two columns: "SampleID" and "cellLabelInImage" of the training dataset respectively correspond to the image number and the cell label inside that image. The third column ("Group") corresponds to the annotated cell type. 

```{r hclust on the JSD matrix}

hier_clustering = hclust(as.dist(JSD_matrix_between_all), method="ward.D")
hier_groups = as.data.frame(cutree(hier_clustering, k=2)); colnames(hier_groups) = "Cluster"

```

## CoxPH model 

Next, we import the training dataset named as "train_data", which has marker data (34 many) for different cells from two different images. The first two columns: "SampleID" and "cellLabelInImage" of the training dataset respectively correspond to the image number and the cell label inside that image. The third column ("Group") corresponds to the annotated cell type. 

```{r CoxPh model with the clusters}

surv = cbind(clinical_data, hier_groups)
coxplot = coxPH_plot(surv)
